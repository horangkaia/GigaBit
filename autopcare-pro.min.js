(function () {
    "use strict";

    // ====================================================
    // LICENSE STORAGE
    // ====================================================
    let licRaw = GM_getValue("apc_license", "");

    function askLicense() {
        const input = prompt("Masukkan License AutoPCare:", licRaw);
        if (input) {
            GM_setValue("apc_license", input.trim());
            alert("License disimpan! Reload halaman.");
            location.reload();
        }
    }

    // FIX: jika license kosong → selalu minta input
    if (!licRaw) {
        setTimeout(askLicense, 100); // FIX (anti prompt blocked)
        return;
    }

    // ====================================================
    // PARSE LICENSE (BASE64.JSON + .SIGNATURE)
    // ====================================================
    function parseLicense(str) {
        if (!str.includes(".")) return null;

        const [payloadB64, signature] = str.split(".");
        if (!payloadB64 || !signature) return null;

        let payloadJson = null;

        try {
            const decoded = atob(payloadB64);
            payloadJson = JSON.parse(decoded);
        } catch (err) {
            console.error("License decode error:", err);
            return null;
        }

        return {
            raw: str,
            payload: payloadJson,
            signature: signature
        };
    }

    const lic = parseLicense(licRaw);

    // FIX: format salah → reset & input ulang
    if (!lic) {
        alert("❌ License rusak / format salah.\nMasukkan license baru.");
        GM_setValue("apc_license", "");
        GM_setValue("apc_license_bind", "");
        location.reload(); // FIX
        return;
    }

    // ====================================================
    // DEVICE LOCK (License tidak bisa digunakan di device lain)
    // ====================================================
    // FIX: device key harus DETERMINISTIK (hapus random)
    function getDeviceKey() {
        return btoa(
            navigator.userAgent +
            navigator.language +
            screen.width + "x" + screen.height +
            Intl.DateTimeFormat().resolvedOptions().timeZone
        ).substring(0, 50);
    }

    const storedBind = GM_getValue("apc_license_bind", "");
    const currentDev = getDeviceKey();

    if (!storedBind) {
        GM_setValue("apc_license_bind", currentDev);
    }

    // FIX: device mismatch → reset & input ulang
    if (storedBind && storedBind !== currentDev) {
        alert("❌ License sudah digunakan di device lain.\nMasukkan license baru.");
        GM_setValue("apc_license", "");
        GM_setValue("apc_license_bind", "");
        location.reload(); // FIX
        return;
    }

    // ====================================================
    // EXPIRE VALIDATION
    // ====================================================
    const now = Math.floor(Date.now() / 1000);
    const exp = lic.payload.expires;

    const isExpired = (!exp || exp < now);

    // FIX: expired → reset & input ulang
    if (isExpired) {
        alert("⏰ License sudah EXPIRED.\nMasukkan license baru.");
        GM_setValue("apc_license", "");
        GM_setValue("apc_license_bind", "");
        location.reload(); // FIX
        return;
    }

    // ====================================================
    // ENABLE / DISABLE PREMIUM FEATURE
    // ====================================================
    var PREMIUM = true;

    // ====================================================
    // COUNTDOWN UI
    // ====================================================
    function showCountdown() {
        const box = document.createElement("div");
        box.id = "apc_timer";
        box.style = `
            position: fixed;
            bottom: 15px;
            left: 15px;
            background: #000a;
            color: white;
            padding: 10px 14px;
            font-size: 13px;
            border-radius: 10px;
            z-index: 999999;
        `;
        document.body.appendChild(box);

        function tick() {
            const now = Math.floor(Date.now() / 1000);
            let left = exp - now;
            if (left < 0) left = 0;

            const d = Math.floor(left / 86400);
            const h = Math.floor((left % 86400) / 3600);
            const m = Math.floor((left % 3600) / 60);
            const s = left % 60;

            box.textContent = `License aktif: ${d}d ${h}h ${m}m ${s}s`;

            if (left > 0) setTimeout(tick, 1000);
        }

        tick();
    }

    showCountdown();

    // ====================================================
    //  GLASS UI AUTO REFRESH PANEL
    // ====================================================
    GM_addStyle(`
        #glassPanel {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 260px;
            padding: 18px;
            border-radius: 18px;
            backdrop-filter: blur(12px);
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.25);
            box-shadow: 0 8px 32px rgba(0,0,0,0.25);
            color: white;
            z-index: 9999999;
            font-family: 'Segoe UI', sans-serif;
        }
        #glassPanel button {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            color: black;
            background: rgba(0,255,150,0.8);
        }
        #glassPanel .stopBtn {
            background: rgba(255,80,80,0.8);
        }
        #glassStatus {
            margin-top: 10px;
            text-align: center;
            font-size: 12px;
            opacity: 0.9;
        }
    `);

    let panel = document.createElement("div");
    panel.id = "glassPanel";
    panel.innerHTML = `
        <h3 style="text-align:center; margin:0;">AutoPCare</h3>

        <button id="startAuto">START AUTO</button>
        <button id="stopAuto" class="stopBtn">STOP</button>

        <div id="glassStatus">Status: OFF</div>
    `;
    document.body.appendChild(panel);

    // ====================================================
    // AUTO REFRESH & SYNC
    // ====================================================
    let tmrRefresh = null;
    let tmrSync = null;

    function refreshNow() {
        try { btn_refresh(); console.log("REFRESH OK"); }
        catch (e) { console.error("ERROR refresh:", e); }
    }

    function syncNow() {
        try { sinkron_antrian(); console.log("SYNC OK"); }
        catch (e) { console.error("ERROR sync:", e); }
    }

    document.getElementById("startAuto").onclick = () => {
        clearInterval(tmrRefresh);
        clearInterval(tmrSync);

        tmrRefresh = setInterval(refreshNow, 5000);
        tmrSync  = setInterval(syncNow, 10000);

        document.getElementById("glassStatus").innerText =
            "RUNNING (Refresh 5s, Sinkron 8s)";
    };

    document.getElementById("stopAuto").onclick = () => {
        clearInterval(tmrRefresh);
        clearInterval(tmrSync);
        tmrRefresh = null;
        tmrSync = null;

        document.getElementById("glassStatus").innerText = "OFF";
    };

})();
