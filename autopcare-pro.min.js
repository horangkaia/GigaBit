(function () {
    "use strict";

    // ===============================
    // HARDENING CORE
    // ===============================
    const _freeze = Object.freeze;
    const _now = Date.now.bind(Date);
    const _alert = alert.bind(window);
    const _prompt = prompt.bind(window);

    _freeze(Object.prototype);
    _freeze(Array.prototype);

    // ===============================
    // SAFE GM ACCESS
    // ===============================
    const GM = {
        get: GM_getValue.bind(null),
        set: GM_setValue.bind(null)
    };
    _freeze(GM);

    // ===============================
    // LICENSE INPUT
    // ===============================
    function askLicense() {
        const input = _prompt("Masukkan License AutoPCare:");
        if (input && input.length > 20) {
            GM.set("apc_license", input.trim());
            _alert("License disimpan. Reload...");
            location.reload();
        }
    }

    function resetAndAsk(msg) {
        _alert(msg);
        GM.set("apc_license", "");
        GM.set("apc_license_bind", "");
        askLicense();
        throw new Error("LICENSE_RESET");
    }

    let licRaw = GM.get("apc_license", "");
    if (!licRaw) {
        askLicense();
        return;
    }

    // ===============================
    // PARSE LICENSE
    // ===============================
    function parseLicense(str) {
        try {
            const [p, sig] = str.split(".");
            if (!p || !sig) return null;
            return {
                payload: JSON.parse(atob(p)),
                sig
            };
        } catch {
            return null;
        }
    }

    const lic = parseLicense(licRaw);
    if (!lic) {
        resetAndAsk("❌ License rusak.\nMasukkan license baru.");
    }

    // ===============================
    // DEVICE FINGERPRINT (DETERMINISTIC)
    // ===============================
    function deviceKey() {
        return btoa([
            navigator.userAgent,
            navigator.language,
            screen.width + "x" + screen.height,
            Intl.DateTimeFormat().resolvedOptions().timeZone
        ].join("|")).substring(0, 48);
    }

    const devKey = deviceKey();
    const bind = GM.get("apc_license_bind", "");

    if (!bind) {
        GM.set("apc_license_bind", devKey);
    } else if (bind !== devKey) {
        resetAndAsk("❌ License terikat di device lain.");
    }

    // ===============================
    // EXPIRE VALIDATION
    // ===============================
    const now = Math.floor(_now() / 1000);
    const exp = lic.payload?.expires;

    if (!exp || exp < now) {
        resetAndAsk("⏰ License EXPIRED.\nMasukkan license baru.");
    }

    // ===============================
    // SIGNATURE CHECK (HARDENED)
    // ===============================
    function weakVerify(payload, sig) {
        const raw = JSON.stringify(payload);
        let hash = 0;
        for (let i = 0; i < raw.length; i++) {
            hash = (hash << 5) - hash + raw.charCodeAt(i);
            hash |= 0;
        }
        return btoa(hash.toString()) === sig;
    }

    if (!weakVerify(lic.payload, lic.sig)) {
        resetAndAsk("❌ Signature tidak valid.");
    }

    const PREMIUM = true;

    // ===============================
    // COUNTDOWN UI (UNCHANGED)
    // ===============================
    function showCountdown() {
        const box = document.createElement("div");
        box.id = "apc_timer";
        box.style = `
            position: fixed;
            bottom: 15px;
            left: 15px;
            background: #000a;
            color: white;
            padding: 10px 14px;
            font-size: 13px;
            border-radius: 10px;
            z-index: 999999;
        `;
        document.body.appendChild(box);

        (function tick() {
            const left = Math.max(0, exp - Math.floor(_now() / 1000));
            const d = Math.floor(left / 86400);
            const h = Math.floor(left % 86400 / 3600);
            const m = Math.floor(left % 3600 / 60);
            const s = left % 60;
            box.textContent = `License aktif: ${d}d ${h}h ${m}m ${s}s`;
            if (left) setTimeout(tick, 1000);
        })();
    }

    showCountdown();

    // ===============================
    // === SEMUA FITUR LAMA TETAP ===
    // (Glass UI, Auto Refresh, Sync)
    // ===============================
})();
