(function () {
    "use strict";

    // ====================================================
    // LICENSE STORAGE & HELPER
    // ====================================================
    let licRaw = GM_getValue("apc_license", "");

    function askLicense() {
        const input = prompt("Masukkan License AutoPCare:");
        if (input) {
            GM_setValue("apc_license", input.trim());
            alert("License disimpan! Reload halaman.");
            location.reload();
        }
    }

    function forceRenew() {
        GM_setValue("apc_license", "");
        GM_setValue("apc_license_bind", "");
        setTimeout(askLicense, 100);
    }

    // ====================================================
    // ====== UI DIBUAT PALING AWAL (WAJIB) ======
    // ====================================================
    GM_addStyle(`
        #glassPanel {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 260px;
            padding: 18px;
            border-radius: 18px;
            backdrop-filter: blur(12px);
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.25);
            box-shadow: 0 8px 32px rgba(0,0,0,0.25);
            color: white;
            z-index: 9999999;
            font-family: 'Segoe UI', sans-serif;
        }
        #glassPanel button {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            color: black;
            background: rgba(0,255,150,0.8);
        }
        #glassPanel .stopBtn {
            background: rgba(255,80,80,0.8);
        }
        #glassPanel .licBtn {
            background: rgba(255,200,0,0.85);
        }
        #glassStatus {
            margin-top: 10px;
            text-align: center;
            font-size: 12px;
            opacity: 0.9;
        }
    `);

    const panel = document.createElement("div");
    panel.id = "glassPanel";
    panel.innerHTML = `
        <h3 style="text-align:center; margin:0;">AutoPCare</h3>
        <button id="startAuto">START AUTO</button>
        <button id="stopAuto" class="stopBtn">STOP</button>
        <button id="licenseBtn" class="licBtn">LICENSE</button>
        <div id="glassStatus">Status: OFF</div>
    `;
    document.body.appendChild(panel);

    // ====================================================
    // LICENSE PARSE
    // ====================================================
    function parseLicense(str) {
        if (!str || !str.includes(".")) return null;
        try {
            const [p, s] = str.split(".");
            return { payload: JSON.parse(atob(p)), sig: s };
        } catch {
            return null;
        }
    }

    let lic = parseLicense(licRaw);

    // ====================================================
    // DEVICE LOCK (STABLE)
    // ====================================================
    function getDeviceKey() {
        return btoa(
            navigator.userAgent +
            navigator.language +
            screen.width + "x" + screen.height +
            Intl.DateTimeFormat().resolvedOptions().timeZone
        ).substring(0, 50);
    }

    const currentDev = getDeviceKey();
    const storedBind = GM_getValue("apc_license_bind", "");

    if (lic && !storedBind) {
        GM_setValue("apc_license_bind", currentDev);
    }

    if (lic && storedBind && storedBind !== currentDev) {
        lic = null;
    }

    // ====================================================
    // EXPIRE CHECK
    // ====================================================
    const now = Math.floor(Date.now() / 1000);
    const exp = lic?.payload?.expires || 0;
    const LICENSE_VALID = exp > now;

    // ====================================================
    // COUNTDOWN UI (SELALU ADA)
    // ====================================================
    function showCountdown() {
        const box = document.createElement("div");
        box.id = "apc_timer";
        box.style = `
            position: fixed;
            bottom: 15px;
            left: 15px;
            background: #000a;
            color: white;
            padding: 10px 14px;
            font-size: 13px;
            border-radius: 10px;
            z-index: 999999;
        `;
        document.body.appendChild(box);

        function tick() {
            const left = Math.max(0, exp - Math.floor(Date.now() / 1000));
            const d = Math.floor(left / 86400);
            const h = Math.floor((left % 86400) / 3600);
            const m = Math.floor((left % 3600) / 60);
            const s = left % 60;

            box.textContent = LICENSE_VALID
                ? `License aktif: ${d}d ${h}h ${m}m ${s}s`
                : `⚠ License EXPIRED — klik LICENSE`;

            setTimeout(tick, 1000);
        }
        tick();
    }

    showCountdown();

    // ====================================================
    // AUTO LOGIC
    // ====================================================
    let tmrRefresh = null;
    let tmrSync = null;

    function refreshNow() {
        try { btn_refresh(); } catch {}
    }

    function syncNow() {
        try { sinkron_antrian(); } catch {}
    }

    document.getElementById("startAuto").onclick = () => {
        if (!LICENSE_VALID) {
            forceRenew();
            return;
        }

        clearInterval(tmrRefresh);
        clearInterval(tmrSync);

        tmrRefresh = setInterval(refreshNow, 8000);
        tmrSync = setInterval(syncNow, 16000);

        document.getElementById("glassStatus").innerText = "RUNNING";
    };

    document.getElementById("stopAuto").onclick = () => {
        clearInterval(tmrRefresh);
        clearInterval(tmrSync);
        document.getElementById("glassStatus").innerText = "OFF";
    };

    // ====================================================
    // LICENSE BUTTON (SELALU AKTIF)
    // ====================================================
    document.getElementById("licenseBtn").onclick = () => {
        forceRenew();
    };

    // ====================================================
    // AUTO PROMPT JIKA LICENSE KOSONG
    // ====================================================
    if (!licRaw) {
        setTimeout(askLicense, 150);
    }

})();
