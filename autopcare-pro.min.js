(function () {
    "use strict";

    // ====================================================
    // LICENSE STORAGE
    // ====================================================
    let licRaw = GM_getValue("apc_license", "");

    function askLicense() {
        const input = prompt("Masukkan License AutoPCare:");
        if (input) {
            GM_setValue("apc_license", input.trim());
            alert("License disimpan! Reload halaman.");
            location.reload();
        }
    }

    // Jika license kosong → selalu minta input
    if (!licRaw) {
        setTimeout(askLicense, 100);
        return;
    }

    // ====================================================
    // PARSE LICENSE (BASE64.JSON + .SIGNATURE)
    // ====================================================
    function parseLicense(str) {
        if (!str.includes(".")) return null;

        const [payloadB64, signature] = str.split(".");
        if (!payloadB64 || !signature) return null;

        try {
            return {
                payload: JSON.parse(atob(payloadB64)),
                signature
            };
        } catch {
            return null;
        }
    }

    const lic = parseLicense(licRaw);

    // License rusak → reset & renew
    if (!lic) {
        alert("❌ License rusak / format salah.\nMasukkan license baru.");
        GM_setValue("apc_license", "");
        GM_setValue("apc_license_bind", "");
        location.reload();
        return;
    }

    // ====================================================
    // DEVICE LOCK (DETERMINISTIC)
    // ====================================================
    function getDeviceKey() {
        return btoa(
            navigator.userAgent +
            navigator.language +
            screen.width + "x" + screen.height +
            Intl.DateTimeFormat().resolvedOptions().timeZone
        ).substring(0, 50);
    }

    const storedBind = GM_getValue("apc_license_bind", "");
    const currentDev = getDeviceKey();

    if (!storedBind) {
        GM_setValue("apc_license_bind", currentDev);
    }

    // Device mismatch → reset & renew
    if (storedBind && storedBind !== currentDev) {
        alert("❌ License terikat di device lain.\nMasukkan license baru.");
        GM_setValue("apc_license", "");
        GM_setValue("apc_license_bind", "");
        location.reload();
        return;
    }

    // ====================================================
    // EXPIRE VALIDATION
    // ====================================================
    const now = Math.floor(Date.now() / 1000);
    const exp = lic.payload.expires;

    if (!exp || exp < now) {
        alert("⏰ License sudah EXPIRED.\nMasukkan license baru.");
        GM_setValue("apc_license", "");
        GM_setValue("apc_license_bind", "");
        location.reload();
        return;
    }

    // ====================================================
    // PREMIUM FIXED TRUE (sampai sini pasti valid)
    // ====================================================
    var PREMIUM = true;

    // ====================================================
    // COUNTDOWN UI
    // ====================================================
    function showCountdown() {
        const box = document.createElement("div");
        box.id = "apc_timer";
        box.style = `
            position: fixed;
            bottom: 15px;
            left: 15px;
            background: #000a;
            color: white;
            padding: 10px 14px;
            font-size: 13px;
            border-radius: 10px;
            z-index: 999999;
        `;
        document.body.appendChild(box);

        function tick() {
            const left = Math.max(0, exp - Math.floor(Date.now() / 1000));
            const d = Math.floor(left / 86400);
            const h = Math.floor((left % 86400) / 3600);
            const m = Math.floor((left % 3600) / 60);
            const s = left % 60;

            box.textContent = `License aktif: ${d}d ${h}h ${m}m ${s}s`;
            if (left > 0) setTimeout(tick, 1000);
        }

        tick();
    }

    showCountdown();

    // ====================================================
    //  GLASS UI AUTO REFRESH PANEL
    // ====================================================
    GM_addStyle(`
        #glassPanel {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 260px;
            padding: 18px;
            border-radius: 18px;
            backdrop-filter: blur(12px);
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.25);
            box-shadow: 0 8px 32px rgba(0,0,0,0.25);
            color: white;
            z-index: 9999999;
            font-family: 'Segoe UI', sans-serif;
        }
        #glassPanel button {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            color: black;
            background: rgba(0,255,150,0.8);
        }
        #glassPanel .stopBtn {
            background: rgba(255,80,80,0.8);
        }
        #glassStatus {
            margin-top: 10px;
            text-align: center;
            font-size: 12px;
            opacity: 0.9;
        }
    `);

    let panel = document.createElement("div");
    panel.id = "glassPanel";
    panel.innerHTML = `
        <h3 style="text-align:center; margin:0;">AutoPCare</h3>
        <button id="startAuto">START AUTO</button>
        <button id="stopAuto" class="stopBtn">STOP</button>
        <div id="glassStatus">Status: OFF</div>
    `;
    document.body.appendChild(panel);

    // ====================================================
    // AUTO REFRESH & SYNC (UNCHANGED)
    // ====================================================
    let tmrRefresh = null;
    let tmrSync = null;

    function refreshNow() {
        try { btn_refresh(); }
        catch (e) { console.error(e); }
    }

    function syncNow() {
        try { sinkron_antrian(); }
        catch (e) { console.error(e); }
    }

    document.getElementById("startAuto").onclick = () => {
        clearInterval(tmrRefresh);
        clearInterval(tmrSync);

        tmrRefresh = setInterval(refreshNow, 5000);
        tmrSync  = setInterval(syncNow, 10000);

        document.getElementById("glassStatus").innerText =
            "RUNNING (Refresh 5s, Sinkron 10s)";
    };

    document.getElementById("stopAuto").onclick = () => {
        clearInterval(tmrRefresh);
        clearInterval(tmrSync);
        tmrRefresh = null;
        tmrSync = null;
        document.getElementById("glassStatus").innerText = "OFF";
    };

})();
